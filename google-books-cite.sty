% google-books-cite.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{google-books-cite}[2025/10/14 v2.2 Google Books page citations]

\RequirePackage{xparse}
\RequirePackage{amsmath}
\RequirePackage{xcolor}
\RequirePackage{hyperref}

\makeatletter

% Configuration
\newcommand{\gb@indicator}{$^{\text{\tiny GB}}$}
\definecolor{gbcolor}{HTML}{008B8B}

% Legacy (no-op)
\newcommand{\SetGoogleBooksID}[2]{}

% Auxiliary file
\newwrite\gb@auxfile
\AtBeginDocument{%
  \immediate\openout\gb@auxfile=\jobname.gbaux
  \immediate\write\gb@auxfile{[}%
}
\newif\ifgb@firstentry
\gb@firstentrytrue
\AtEndDocument{%
  \immediate\write\gb@auxfile{]}%
  \immediate\closeout\gb@auxfile
}

% Write JSON entry
\newcommand{\gb@writejson}[2]{%
  \ifgb@firstentry
    \gb@firstentryfalse
  \else
    \immediate\write\gb@auxfile{,}%
  \fi
  \immediate\write\gb@auxfile{{"key": "#1", "page": "#2"}}%
}

% Check if link exists
\newcommand{\ifgblink}[2]{%
  \ifcsname gblink@#1@#2\endcsname
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi
}

\newcommand{\getgblink}[2]{%
  \csname gblink@#1@#2\endcsname
}

% Citation commands
\NewDocumentCommand{\gbparencite}{o m}{%
  \IfNoValueTF{#1}{%
    \parencite{#2}%
  }{%
    \gb@writejson{#2}{#1}%
    \ifgblink{#2}{#1}{%
      (\citeauthor{#2}, \citeyear{#2}, %
       {\color{gbcolor}\href{\getgblink{#2}{#1}}{#1\gb@indicator}})%
    }{%
      \parencite[#1]{#2}%
    }%
  }%
}

\NewDocumentCommand{\gbtextcite}{o m}{%
  \IfNoValueTF{#1}{%
    \textcite{#2}%
  }{%
    \gb@writejson{#2}{#1}%
    \ifgblink{#2}{#1}{%
      \citeauthor{#2} (\citeyear{#2}, %
       {\color{gbcolor}\href{\getgblink{#2}{#1}}{#1\gb@indicator}})%
    }{%
      \textcite[#1]{#2}%
    }%
  }%
}

\newcommand{\gbdisclaimer}{%
  \footnote{Links marked with $^{\text{\tiny GB}}$ point to Google Books digitized 
  copies. Page numbers reference print editions in the bibliography.}%
}

% Include links file
\IfFileExists{\jobname.gblinks.tex}{%
  \input{\jobname.gblinks.tex}%
}{}

\makeatother
\endinput
