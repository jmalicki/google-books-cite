% google-books-cite.sty
% LaTeX package for citations with page-level Google Books links
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{google-books-cite}[2025/10/14 v0.4 Google Books page citations]

\RequirePackage{xparse}
RequirePackage{amsmath}
\RequirePackage{xstring}
\RequirePackage{xcolor}

% Configuration
\newcommand{\gb@indicator}{$^{\text{\tiny GB}}$}
\definecolor{gbcolor}{HTML}{008B8B}

% Simple ID storage using csname
\newcommand{\SetGoogleBooksID}[2]{%
  \expandafter\gdef\csname gbid@#1\endcsname{#2}%
}

\newcommand{\GetGoogleBooksID}[1]{%
  \ifcsname gbid@#1\endcsname
    \csname gbid@#1\endcsname
  \fi
}

% Check if ID exists
\newcommand{\ifgbid}[1]{%
  \ifcsname gbid@#1\endcsname
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi
}

% Extract page number helper
\def\gb@extractpageaux#1{%
  \StrSubstitute{#1}{p.~}{}[\gb@a]%
  \StrSubstitute{\gb@a}{pp.~}{}[\gb@b]%
  \StrSubstitute{\gb@b}{ }{}[\gb@c]%
  \StrBefore{\gb@c}{-}[\gb@d]%
  \IfStrEq{\gb@d}{}{%
    \let\gb@finalpage\gb@c
  }{%
    \let\gb@finalpage\gb@d
  }%
}

% Main citation command
\NewDocumentCommand{\gbparencite}{o m}{%
  \IfNoValueTF{#1}{%
    \parencite{#2}%
  }{%
    \ifgbid{#2}{%
      % Has Google Books ID
      \gb@extractpageaux{#1}%
      \edef\gb@url{https://books.google.com/books?id=\GetGoogleBooksID{#2}\&pg=PA\gb@finalpage}%
      (\citeauthor{#2}, \citeyear{#2}, %
       {\color{gbcolor}\href{\gb@url}{#1\gb@indicator}})%
    }{%
      % No ID, regular citation
      \parencite[#1]{#2}%
    }%
  }%
}

% Text citation variant
\NewDocumentCommand{\gbtextcite}{o m}{%
  \IfNoValueTF{#1}{%
    \textcite{#2}%
  }{%
    \ifgbid{#2}{%
      \gb@extractpageaux{#1}%
      \edef\gb@url{https://books.google.com/books?id=\GetGoogleBooksID{#2}\&pg=PA\gb@finalpage}%
      \citeauthor{#2} (\citeyear{#2}, %
      {\color{gbcolor}\href{\gb@url}{#1\gb@indicator}})%
    }{%
      \textcite[#1]{#2}%
    }%
  }%
}

\newcommand{\gbdisclaimer}{%
  \footnote{Links marked with $^{\text{\tiny GB}}$ point to Google Books digitized 
  copies. Page numbers reference print editions in the bibliography.}%
}

\endinput
