# Complete Workflow Guide

## Overview

The google-books-cite system uses a **two-pass compilation** approach:

```
Pass 1: LaTeX → .gbaux (JSON file with citation requests)
        ↓
Python: .gbaux + .bib → .gblinks.tex (URL definitions)
        ↓
Pass 2: LaTeX → PDF (with clickable page links)
```

## Step-by-Step Workflow

### Initial Setup (Once)

1. **Add package to your project:**
   ```bash
   git submodule add https://github.com/jmalicki/google-books-cite.git
   ```

2. **Install the tool:**
   ```bash
   cd google-books-cite/tools
   uv pip install -e .
   ```

3. **Add package to your LaTeX document:**
   ```latex
   \usepackage{google-books-cite/google-books-cite}
   ```

4. **Configure BibLaTeX for clickable titles (optional but recommended):**
   ```latex
   % Make bibliography titles clickable, hide URL text
   \DeclareFieldFormat{url}{\relax}  % Don't print URL
   \DeclareFieldFormat{title}{%
     \iffieldundef{url}{%
       \mkbibemph{#1}%
     }{%
       \href{\thefield{url}}{\mkbibemph{#1}}%
     }%
   }
   ```

### One-Time: Augment Bibliography

5. **Find Google Books IDs (read-only analysis):**
   ```bash
   gbfind paper/everyone.bib
   ```
   
   Review the report:
   - ✓ Found: Confident matches
   - ⚠ Ambiguous: Multiple matches (verify manually)
   - ✗ Not found: No Google Books results

6. **Augment your .bib file:**
   ```bash
   # Preview changes
   gbfind --augment paper/everyone.bib --dry-run
   
   # Apply changes
   gbfind --augment paper/everyone.bib
   ```
   
   This adds `googlebooksid` and `url` fields to your bibliography entries.

7. **Manually verify ambiguous entries:**
   For entries marked as ambiguous, use interactive mode:
   ```bash
   gbfind --interactive
   ```
   
   Then manually add the correct ID to your .bib file:
   ```bibtex
   @book{MyBook,
     author = {Author},
     title = {Title},
     year = {2000},
     googlebooksid = {CorrectID123},  % Add this
     url = {https://books.google.com/books?id=CorrectID123},  % Add this
   }
   ```

### Regular Workflow: Compiling Your Document

8. **Update citations in your .tex files:**
   
   For works with Google Books IDs, use `\gbparencite` instead of `\parencite`:
   ```latex
   % Before:
   \parencite[p.~312]{SchopenhauerWWR1969}
   
   % After (if SchopenhauerWWR1969 has googlebooksid):
   \gbparencite[p.~312]{SchopenhauerWWR1969}
   ```
   
   **Tip:** Only convert citations for entries that have `googlebooksid` in your .bib file!

9. **Add disclaimer footnote** (first use in your document):
   ```latex
   \footnote{Where available, bibliographic entries include links to Google 
   Books digitized copies. These are provided for reader convenience. Page 
   numbers reference the print editions listed in the bibliography.}
   ```

10. **Compile with the two-pass system:**

    **Manual approach:**
    ```bash
    xelatex main.tex          # Pass 1: generates .gbaux
    biber main
    gbfind --make-links paper/main  # Generates .gblinks.tex
    xelatex main.tex          # Pass 2: includes links
    xelatex main.tex          # Pass 3: resolve references
    ```

    **Makefile approach:**
    ```makefile
    main.pdf: main.tex everyone.bib
        cd paper && xelatex main.tex
        cd paper && biber main
        gbfind --make-links paper/main
        cd paper && xelatex main.tex
        cd paper && xelatex main.tex
    ```

## What You Get

### In the Bibliography
- **Clickable titles**: Book titles link to Google Books
- **Clean appearance**: URLs hidden from print output
- **Works with any PDF reader**: Evince, Adobe, Preview, etc.

Example:
```
Schopenhauer, A. (1969). The world as will and representation.  ← title is clickable
```

### In Citations
- **Clickable page numbers**: Direct links to specific pages
- **Visual indicator**: ᴳᴮ superscript shows it's a Google Books link
- **Colored links**: Teal/cyan to distinguish from regular links

Example:
```
(Schopenhauer, 1969, p. 312ᴳᴮ)  ← "p. 312ᴳᴮ" is clickable, links to page 312
```

## Files Generated

- **`.gbaux`**: JSON file with citation requests (generated by LaTeX, consumed by Python)
- **`.gblinks.tex`**: LaTeX definitions mapping citations to URLs (generated by Python, consumed by LaTeX)
- **`.bib.backup`**: Backup of your bibliography before augmentation

## Troubleshooting

### Links not clickable

1. Check that the entry has a `googlebooksid` in your .bib file
2. Verify you ran `gbfind --make-links` between LaTeX passes
3. Check that `.gblinks.tex` exists and was generated
4. Ensure you're using `\gbparencite` not `\parencite`

### Wrong book opens

The automatic search sometimes finds wrong editions. To fix:

1. Manually search Google Books for your exact edition
2. Get the ID from the URL: `books.google.com/books?id=CORRECT_ID`
3. Update your .bib file with the correct `googlebooksid`
4. Regenerate: `gbfind --make-links paper/main`
5. Recompile

### Page number doesn't match

Different editions have different pagination. Ensure:
- The Google Books ID matches your cited edition
- The page numbers in your citations match that edition
- Consider noting edition differences in your bibliography

## Best Practices

1. **Verify IDs for frequently-cited works**: Don't blindly trust automatic search
2. **Check a sample link** before finalizing: Click a few GB links to verify they go to correct pages
3. **Keep .bib.backup**: In case you need to revert changes
4. **Commit .gblinks.tex**: Include in version control so collaborators have the same links
5. **Document discrepancies**: If page numbers differ between editions, note it

## Limitations

- Only supports arabic page numbers (PA prefix) currently
- Roman numerals and preliminary pages not yet supported
- Requires two-pass compilation (can't be done in one pass)
- Google Books availability varies by region and copyright status
- Some books have limited preview or no preview

## Future Enhancements

See [RESEARCH.md](RESEARCH.md) for planned features.

